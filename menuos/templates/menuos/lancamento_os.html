{% extends "base.html" %}
{% load static %}
{% block body %}

<div class="flex min-h-screen bg-slate-900 items-center justify-center px-6 py-12">
  <div class="w-full max-w-md bg-slate-800 rounded-2xl shadow-lg p-8 text-center">
    <img src="{% static 'Logo_IMA.png' %}" alt="Logo_IMA" class="mx-auto h-14 w-auto rounded-full" />
    <h2 class="text-2xl font-bold text-white mb-2">Iniciar Ordem de Serviço</h2>
    <p class="text-gray-400 mb-8">
      Informe sua matrícula e o número da OS.
    </p>

    <form method="POST" id="form-iniciar-os" class="space-y-6 text-left">
      {% csrf_token %}
      <div id="msg_erro" class="hidden mb-4 text-red-500 text-center"></div>

      <div>
        <label for="matricula" class="block text-sm font-medium text-gray-200 mb-1">Matrícula</label>
        <input
          type="text"
          name="matricula"
          id="matricula"
          required
          placeholder="Digite sua matrícula"
          class="w-full rounded-md bg-white/10 px-3 py-2 text-white placeholder-gray-500 outline outline-1 outline-white/20 focus:outline-indigo-500 sm:text-sm"
        />
      </div>

      <div>
        <label for="numero_os" class="block text-sm font-medium text-gray-200 mb-1">Número da OS</label>
        <input
          type="text"
          name="numero_os"
          id="numero_os"
          required
          placeholder="Digite o número da OS"
          class="w-full rounded-md bg-white/10 px-3 py-2 text-white placeholder-gray-500 outline outline-1 outline-white/20 focus:outline-indigo-500 sm:text-sm"
        />
      </div>

      <div>
        <button
          type="button"
          id="btn_verificar"
          class="w-full rounded-md bg-indigo-600 px-4 py-2 text-white font-semibold hover:bg-indigo-500 transition"
        >
          Verificar
        </button>
      </div>

      <div id="colaborador_info" class="hidden">
        <label for="nome_colaborador" class="block text-sm font-medium text-gray-200 mb-1">Nome do Colaborador</label>
        <input
          type="text"
          name="nome_colaborador"
          id="nome_colaborador"
          readonly
          class="w-full rounded-md bg-white/20 px-3 py-2 text-white outline outline-1 outline-white/20 sm:text-sm"
        />
      </div>

      <div id="descricao_os_info" class="hidden">
        <label for="descricao_os" class="block text-sm font-medium text-gray-200 mb-1 mt-4">Descrição da OS</label>
        <textarea
          name="descricao_os"
          id="descricao_os"
          rows="4"
          readonly
          class="w-full rounded-md bg-white/20 px-3 py-2 text-white outline outline-1 outline-white/20 sm:text-sm"
        ></textarea>
      </div>

      <div id="botao_iniciar_container" class="hidden mt-6">
        <button
          type="submit"
          class="w-full rounded-md bg-green-600 px-4 py-2 text-white font-semibold hover:bg-green-500 transition"
        >
          Iniciar OS
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Sucesso -->
<div
  id="modal_sucesso"
  style="display:none;"
  class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50"
>
  <div class="bg-slate-100 rounded-lg p-8 max-w-md w-full text-left">
    <h2 class="text-xl font-bold mb-6 text-green-700 text-center">Hora iniciada com sucesso!</h2>
    <div class="space-y-3 text-gray-800 text-sm">
      <p><strong>Número da OS:</strong><br /><span id="modal_numero_os"></span></p>
      <p><strong>Descrição da OS:</strong><br /><span id="modal_descricao_os"></span></p>
      <p><strong>Colaborador:</strong><br /><span id="modal_nome_colaborador"></span> (<span id="modal_matricula_colaborador"></span>)</p>
    </div>
    <p class="mt-6 text-center text-gray-600">Você será redirecionado em <span id="modal_timer">10</span> segundos.</p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const btnVerificar = document.getElementById("btn_verificar");
  const matriculaInput = document.getElementById("matricula");
  const numeroOsInput = document.getElementById("numero_os");
  const nomeColaboradorInput = document.getElementById("nome_colaborador");
  const descricaoOsInput = document.getElementById("descricao_os");

  const colaboradorInfo = document.getElementById("colaborador_info");
  const descricaoOsInfo = document.getElementById("descricao_os_info");
  const botaoIniciar = document.getElementById("botao_iniciar_container");

  const msgErro = document.getElementById("msg_erro");

  const modal = document.getElementById("modal_sucesso");
  const modalNumOs = document.getElementById("modal_numero_os");
  const modalDescOs = document.getElementById("modal_descricao_os");
  const modalNomeColab = document.getElementById("modal_nome_colaborador");
  const modalMatriculaColab = document.getElementById("modal_matricula_colaborador");
  const modalTimer = document.getElementById("modal_timer");

  btnVerificar.addEventListener("click", function () {
    msgErro.classList.add("hidden");
    const matricula = matriculaInput.value.trim();
    const numeroOs = numeroOsInput.value.trim();

    if (!matricula || !numeroOs) {
      msgErro.textContent = "Preencha os dois campos para verificar.";
      msgErro.classList.remove("hidden");
      return;
    }

    fetch(`/menuos/buscar-dados-os/?matricula=${encodeURIComponent(matricula)}&numero_os=${encodeURIComponent(numeroOs)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(response => response.json())
      .then(data => {
        if (data.valido) {
          nomeColaboradorInput.value = data.nome_colaborador;
          descricaoOsInput.value = data.descricao_os;

          colaboradorInfo.classList.remove("hidden");
          descricaoOsInfo.classList.remove("hidden");
          botaoIniciar.classList.remove("hidden");
        } else {
          msgErro.textContent = "Matrícula ou Número da OS inválidos ou inexistentes.";
          msgErro.classList.remove("hidden");
          colaboradorInfo.classList.add("hidden");
          descricaoOsInfo.classList.add("hidden");
          botaoIniciar.classList.add("hidden");
          nomeColaboradorInput.value = "";
          descricaoOsInput.value = "";
        }
      })
      .catch(error => {
        console.error("Erro ao buscar dados:", error);
        msgErro.textContent = "Erro na comunicação com o servidor.";
        msgErro.classList.remove("hidden");
      });
  });

  document.getElementById("form-iniciar-os").addEventListener("submit", function (e) {
    e.preventDefault();

    const matricula = matriculaInput.value.trim();
    const numeroOs = numeroOsInput.value.trim();
    const nomeColaborador = nomeColaboradorInput.value.trim();
    const descricaoOs = descricaoOsInput.value.trim();

    if (!matricula || !numeroOs || !nomeColaborador || !descricaoOs) {
      msgErro.textContent = "Preencha e verifique os dados antes de iniciar a OS.";
      msgErro.classList.remove("hidden");
      return;
    }

    fetch("/menuos/iniciar-os/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ matricula, numero_os: numeroOs }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.sucesso) {
          document.querySelector("form#form-iniciar-os").style.display = "none";
          msgErro.classList.add("hidden");

          modalNumOs.textContent = numeroOs;
          modalDescOs.textContent = descricaoOs;
          modalNomeColab.textContent = nomeColaborador;
          modalMatriculaColab.textContent = matricula;
          modal.style.display = "flex";

          let timer = 6;
          modalTimer.textContent = timer;

          const intervalo = setInterval(() => {
            timer--;
            modalTimer.textContent = timer;
            if (timer <= 0) {
              clearInterval(intervalo);
              window.location.href = "/menuos/iniciar-os/";
            }
          }, 1000);
        } else {
          msgErro.textContent = data.mensagem || "Erro ao iniciar a OS.";
          msgErro.classList.remove("hidden");
        }
      })
      .catch(() => {
        msgErro.textContent = "Erro na comunicação com o servidor.";
        msgErro.classList.remove("hidden");
      });
  });
});
</script>

{% endblock %}
